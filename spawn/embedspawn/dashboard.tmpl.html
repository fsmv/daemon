<!doctype html>
<html>
	<head>
<style>
.server-list span {
	display: inline-block;
}
.status {
	width: 3.5em;
	text-align: center;
	vertical-align: text-bottom;
}
.name {
	min-width: 13em;
	vertical-align: text-bottom;
}
.server-list p {
	margin-top: 0.5em;
	margin-bottom: 0;
}
.server-list form {
	display: inline;
}
.code {
	font-family: monospace;
	white-space: pre;
	user-select: all;
}
pre.logs {
	background-color: #EEE;
	margin: 0.5em 4.5em 0;
	overflow: auto;
	max-height: 15em;
	min-height: 1.5em;

	/* Make the text stay scrolled at the bottom when appending */
	display: flex;
	flex-direction: column-reverse;
}
ul.server-list {
	list-style: none;
	margin: 0 auto;
	padding: 0;
	max-width: 80em;
}
li.server {
	margin-bottom: 0.5em;
}
</style>
<script>
	const eventSource= new EventSource(`./logs`);
	var streams = new Map()

	function Setup() {
		[...document.getElementsByClassName("name")].forEach(elm => {
				StreamLogs(elm.innerHTML)
			})
	}

	function StreamLogs(serverName) {
		const logsElm = document.getElementById(`logs-${serverName}`);
		eventSource.addEventListener(serverName, function(event) {
				text = document.createTextNode(event.data+"\n");
				logsElm.appendChild(text);
			});
	}
</script>
	</head>
	<body onload="Setup();">
	{{with VersionInfo}}
	{{if len .Version | ne 0}}
		<h2>daemon {{.Version}}</h2>
	{{end}}
	{{if len .UpdateVersion | ne 0}}
		<h3>{{.UpdateVersion}} is now available</h3>
		<p>To update run: <span class="code">
				CGO_ENABLED=0 go install ask.systems/daemon@latest
		</span></p>
	{{end}}
	{{end}}
		<ul class="server-list">
			<li class="server">
				<span class="status" style="color:darkgreen">UP</span>
				<span class="name">spawn</span>
				<form method="post">
					<button type="submit" name="submit" value="reload-config">Reload Config</button>
				</form>
				<pre class="logs" id="logs-spawn"></pre>
			</li>
			{{range .}}
			<li class="server">
				{{if .Up}}
				<span class="status" style="color:darkgreen">UP</span>
				{{else}}
				<span class="status" style="color:red">DOWN</span>
				{{end}}

				<span class="name">{{.Name}}</span>

				<form method="post">
					<input type="hidden" name="name" value="{{.Name}}" />
					<button type="submit" name="submit" value="restart">Restart Server</button>
				</form>

				<pre class="logs" id="logs-{{.Name}}"></pre>

				{{if not .Up }}
				<p>{{.Message}}</p>
				{{end}}
			</li>
			{{end}}
		</ul>
	</body>
</html>
{{- /* vim: set noexpandtab: */ -}}
